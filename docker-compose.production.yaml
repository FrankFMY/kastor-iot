# KASTOR IoT - Production Docker Compose (HOST NETWORKING MODE)
# Оптимизированная версия для VPS (TimeWeb, Beget, DigitalOcean, etc.)
#
# Быстрый старт:
#   ./scripts/deploy.sh demo
#
# Или вручную:
#   docker compose -f docker-compose.production.yaml --profile demo up -d

services:
  # ═══════════════════════════════════════════════════════════════
  # DATABASE - TimescaleDB (PostgreSQL с расширениями для time-series)
  # База данных автоматически инициализируется при первом запуске
  # ═══════════════════════════════════════════════════════════════
  db:
    image: timescale/timescaledb:latest-pg17
    container_name: kastor-db
    restart: always
    network_mode: host
    environment:
      POSTGRES_USER: ${DB_USER:-kastor}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-kastor_secure_password_2026}
      POSTGRES_DB: ${DB_NAME:-kastor}
    volumes:
      - pgdata:/var/lib/postgresql/data
      # Автоматическая инициализация БД при первом запуске
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-kastor} -d ${DB_NAME:-kastor}']
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════
  # MQTT BROKER - EMQX для IoT телеметрии
  # ═══════════════════════════════════════════════════════════════
  emqx:
    image: emqx/emqx:6.0.1
    container_name: kastor-emqx
    restart: always
    network_mode: host
    environment:
      EMQX_ALLOW_ANONYMOUS: 'true'
      EMQX_LISTENERS__TCP__DEFAULT__BIND: '0.0.0.0:1883'
      EMQX_LISTENERS__WS__DEFAULT__BIND: '0.0.0.0:8083'
      EMQX_DASHBOARD__LISTENERS__HTTP__BIND: '0.0.0.0:18083'
      EMQX_DASHBOARD__DEFAULT_USERNAME: 'admin'
      EMQX_DASHBOARD__DEFAULT_PASSWORD: '${MQTT_ADMIN_PASSWORD:-kastor_mqtt_2026}'
    volumes:
      - emqxdata:/opt/emqx/data
    healthcheck:
      test: ['CMD', 'emqx', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════
  # APPLICATION - KASTOR IoT SvelteKit App
  # ═══════════════════════════════════════════════════════════════
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kastor-app
    restart: always
    network_mode: host
    environment:
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0
      # Database - подключение через localhost (host networking)
      DATABASE_URL: postgres://${DB_USER:-kastor}:${DB_PASSWORD:-kastor_secure_password_2026}@127.0.0.1:5432/${DB_NAME:-kastor}
      # MQTT - подключение через localhost
      MQTT_URL: mqtt://127.0.0.1:1883
      MQTT_USERNAME: ${MQTT_USERNAME:-kastor_app}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-kastor_mqtt_app_2026}
      # Auth
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-kastor-demo-secret-change-in-production-32chars}
      AUTH_SECRET: ${AUTH_SECRET:-kastor-demo-secret-change-in-production-32chars}
      TRUSTED_ORIGINS: ${TRUSTED_ORIGINS:-http://localhost:3000}
      # Demo mode - disable real alerts, use mocked data from seed
      DEMO_MODE: ${DEMO_MODE:-true}
    healthcheck:
      test:
        ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:3000/api/health']
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5
    depends_on:
      db:
        condition: service_healthy
      emqx:
        condition: service_healthy

  # ═══════════════════════════════════════════════════════════════
  # SIMULATOR - Генератор демо-данных
  # ═══════════════════════════════════════════════════════════════
  simulator:
    build:
      context: .
      dockerfile: Dockerfile.simulator
    container_name: kastor-simulator
    restart: unless-stopped
    network_mode: host
    environment:
      MQTT_URL: mqtt://127.0.0.1:1883
      MQTT_USERNAME: ${MQTT_USERNAME:-kastor_app}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-kastor_mqtt_app_2026}
    profiles:
      - demo
    depends_on:
      app:
        condition: service_healthy

volumes:
  pgdata:
    driver: local
  emqxdata:
    driver: local
